<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>PoorMansTSqlFormatterJS Demo Harness</title>
    <meta name="description" content="This is a simple demo page for the PoorMansTSqlFormatterJS library - more complete site at http://poorsql.com/">

    <link href="DemoSupportFiles/minimal.css" rel="stylesheet">
    <script src="DemoSupportFiles/jquery-1.5.2.min.js"></script>
    <script src="DemoSupportFiles/formattingengine.js"></script>

    <script>
        var PageService = function () {
            var EnableUI = function () {
                //$("#inputString").enableme(); //however that works...
                $("#inputString").change(inputChanged);
                $("#inputString").blur(inputChanged);
            }

            var inputChanged = function () {
                SetOutputPanelContent("Getting formatted SQL, please wait...");
                JsFormattingEngine.RequestFormatting("inputString=" + encodeURIComponent($("#inputString").val()) + "&expandCommaLists=true&trailingCommas=true&spaceAfterExpandedComma=false&expandBooleanExpressions=true&expandCaseStatements=true&expandBetweenConditions=true&expandInLists=true&breakJoinOnSections=false&uppercaseKeywords=true&coloring=true&keywordStandardization=false&randomizeColor=false&randomizeLineLengths=false&randomizeKeywordCase=false&preserveComments=false&enableKeywordSubstitution=false&formattingType=standard&indent=%5Ct&spacesPerTab=4&maxLineWidth=999&statementBreaks=2&clauseBreaks=1&language=&jsengine=true&reFormat=true&obfuscate=false");
            }

            //var inputKeyEventFireFormat = function () {
            //    doFormatInPlace();
            //    formatToOutDiv();
            //}

            var SetOutputPanelContent = function (outputData) {
                $("#outputDiv").html(outputData);
            }

            var NotifyFormattingResult = function (formattingResult) {
                //TODO: add safety here, against race conditions etc.
                SetOutputPanelContent(formattingResult.outputSqlHtml);
            }

            var initializeFromSettings = function () {
                if (formatAsYouType)
                    $('#inputString').keyup(inputKeyEventFireFormat)
                else
                    //untested...
                    $("#inputString").keyup(null);
            }

            var formatToOutDiv = function () {
                setOutput(formattedText);
            }

            var doFormatInPlace = function () {
                if (formatInPlace) {
                    var tokenizedData = tokenizer.TokenizeSQL(inputData);
                    var parsedData = parser.ParseSQL(tokenizedData);
                    var formattedText = textFormatter.FormatSQLTree(parsedData);

                    $("#inputString").val(formattedText);
                }
            }


            return {
                EnableUI: EnableUI,
                SetOutputPanelContent: SetOutputPanelContent,
                NotifyFormattingResult: NotifyFormattingResult
            };
        }();
    </script>
    <script>
        $(function () {
            var minflag = false;

            var scriptURLList = [
                'JSLibReference/bridge.' + (minflag ? "min." : "") + 'js',
                'JSLibReference/bridge.meta.' + (minflag ? "min." : "") + 'js',
                'JSLibReference/PoorMansTSqlFormatterJS.' + (minflag ? "min." : "") + 'js',
                'JSLibReference/PoorMansTSqlFormatterJS.meta.' + (minflag ? "min." : "") + 'js',
                'DemoSupportFiles/formattingmapper.js'
            ];

            //not picked up dynamically yet - I can't figure out how to test checked fields...?
            var formatAsYouType = true;
            //TODO: not implemented yet!!
            var formatInPlace = false;

            JsFormattingEngine.LoadEnvironment(
              document.location.href.split("?")[0].replace('DemoPage.html', ''),
              'DemoSupportFiles/formattingworker.js',
              scriptURLList,
              function () { PageService.EnableUI(); },
              function (paramLength, outputString) { PageService.SetOutputPanelContent(outputString); },
              function (errorMessage) { PageService.SetOutputPanelContent("Error: " + errorMessage); }
            );

        });
    </script>
</head>
<body>
    <header>
        <span class="logo">PoorMansTSqlFormatterJS Demo Harness
        </span>
        <nav class="float-right">
            <ul>
                <li><label><input type="checkbox" name="EnableFormatAsYouGo" id="formatAsYouGo" /> Format as-you-go</label></li>
                <li><label><input type="checkbox" name="EnableInPlaceFormat" id="inPlaceFormat" disabled="disabled" /> In-place format</label></li>
            </ul>
        </nav>
    </header>
    <div class="row">
        <div class="col-6">
            <textarea name="inputString" id="inputString" style="width: 100%; height: 80vh; padding: 2px; border: 1px solid; " ></textarea>
        </div>
        <div class="col-6">
            <div id="outputDiv" style="height:80vh; padding: 2px; border: 1px solid; overflow: scroll;">
            </div>
        </div>
    </div>
    <footer>
        Please note - <b>Debug</b> JS libraries are copied from the PoorMansTSqlFormatterJSLib project, whenever this WebDemo project is built. If the compiled JS files are missing (if a debug build has not completed), then the WebDemo project will report an error at build time.
    </footer>
</body>
</html>